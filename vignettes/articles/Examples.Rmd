---
title: "Examples"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(fChange)
```

# Overview

In this article, we examine severl applications for fChange.

# Electricity

This section examines the hourly Spanish electricity spot price from 2014. This
data is loaded into ${\tt fChange}$, and can be retrieved by calling `electricity`. 
The goal is to detect any changes in the data.

This data may be viewed using the following:
```{r setup}
library(fChange)

plot(funts(electricity),
        val_axis_title = '',res_axis_title = '',FD_axis_title = '',
        plot_title = '')
```

This data seems to exhibit some trends over time (perhaps due to season). We wish to model these trends first, and then search the data for any remaining changes. We will use principal component analysis to convert it to finite dimensions, fit a model, and return this to functional data. In \code{fChange}, \code{pca_examination} and \code{model_pca} are pre-built functions that can be used to project the data, e.g.
```{r prebuilt, eval=FALSE}
epca <- pca_examination(funts(electricity),order = 7) 
set.seed(654321)
res1 <- binary_segmentation(X = epca$residuals,
                           statistic='Tn',
                           method='Sim',
                           h_function = function(X){ncol(X)^(1/3)})
```

The previous approach is similar to the next, except without smoothing incorporated. In the next, we show the details more precisely.
```{r model_electricity, eval=FALSE}
set.seed(123456)
electricity_fd <- fda::Data2fd(1:24, electricity)

# 3 gets 95%, 7 gets 99% TVE
nPCs <- 7
electricity_fpca <- fda::pca.fd(electricity_fd, nharm = nPCs)
electricity_fpca_comp <- electricity_fpca$scores

## Forecast Each
ts_dat <- list()
comps <- list()
comps_resids <- list()
for (i in 1:nPCs) {
  ts_dat[[i]] <- stats::ts(electricity_fpca_comp[, i], freq = 7)
  comps[[i]] <- forecast::ets(ts_dat[[i]])
  comps_resids[[i]] <- stats::resid(comps[[i]])
}

electricity_fpca_forecast <- do.call(cbind, comps_resids)

# Revert Back to functional objects
residuals1 <- electricity_fpca$harmonics$coefs %*% t(electricity_fpca_forecast)
residuals_fd <- fda::eval.basis(1:24, electricity_fd$basis) %*% residuals1
```

We use binary segmentation to investigate the residuals in this case.
```{r binary_segmantation, eval=FALSE}
set.seed(654321)
res <- binary_segmentation(X = residuals_fd,
                           statistic='Tn',
                           method='Sim',
                           h_function = function(X){ncol(X)^(1/3)})
colnames(residuals_fd)<- colnames(electricity)
plot(funts(residuals_fd), res[[1]]) 
```

# S\&P 500

This section is focused on an application in finance, specifically the S\&P500 index. \code{fChange} includes this data as \code{SPYUS500}, which is pre-loaded. The aim is to detect changes in the stock prices.

The data is collected at minutely resolution. We convert it into the overnight cumulative intraday returns below, and plot it.
```{r functions}
library(fChange)

compute_ocidr <- function(dat){
  dat_cidr <- dat
  dat_cidr[,1]  <- 100*(log(dat[,1]) - log(dat[1,1]))
  # Obs
  for(j in 2:ncol(dat_cidr)){ 
    dat_cidr[,j] <- 100 * 
      ( log(dat[,j]) - log(dat[nrow(dat_cidr),j-1]) )
  }
  
  dat_cidr
}

SPYUS_ocidr <- compute_ocidr(SPYUS500)

plot_ocidr <- plot(funts(SPYUS_ocidr),
                      val_axis_title = '',res_axis_title = '',FD_axis_title = '',
                      plot_title = '')
```

The changes can be detected using binary segmentation as follows.
```{r detect_changes, eval=FALSE}

set.seed(25641)
spy_min_cps <- binary_segmentation(SPYUS_ocidr,
                                   statistic='Tn',
                                   method='Sim',
                                   h_function = function(X){ncol(X)^(1/3)})
plot_ocidr <- plot(funts(SPYUS_ocidr),CPs = spy_min_cps[[1]],
                      val_axis_title = '',res_axis_title = '',FD_axis_title = '',
                      plot_title = '')
```


