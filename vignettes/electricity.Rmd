---
title: "electricity"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{electricity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette examines the hourly Spanish electricity spot price from 2014. This
data is loaded into ${\tt fChange}$, and can be retrieved by calling `electricity`. 
The goal is to detect any changes in the data.

# Investigate

This data may be viewed using the following:
```{r setup}
library(fChange)

plot(funts(electricity),
        val_axis_title = '',res_axis_title = '',FD_axis_title = '',
        plot_title = '')
```

This data seems to exhibit some trends over time (perhaps due to season). We wish to model these trends first, and then search the data for any remaining changes. We will use principal component analysis to convert it to finite dimensions, fit a model, and return this to functional data. In \code{fChange}, \code{pca_examination} and \code{model_pca} are pre-built functions that can be used to project the data, e.g.
```{r prebuilt, eval=FALSE}
epca <- pca_examination(funts(electricity),order = 7) 
set.seed(654321)
res1 <- binary_segmentation(X = epca$residuals,
                           statistic='Tn',
                           method='Sim',
                           h_function = function(X){ncol(X)^(1/3)})
```

The previous approach is similar to the next, except without smoothing incorporated. In the next, we show the details more precisely.
```{r model_electricity, eval=FALSE}
set.seed(123456)
electricity_fd <- fda::Data2fd(1:24, electricity)

# 3 gets 95%, 7 gets 99% TVE
nPCs <- 7
electricity_fpca <- fda::pca.fd(electricity_fd, nharm = nPCs)
electricity_fpca_comp <- electricity_fpca$scores

## Forecast Each
ts_dat <- list()
comps <- list()
comps_resids <- list()
for (i in 1:nPCs) {
  ts_dat[[i]] <- stats::ts(electricity_fpca_comp[, i], freq = 7)
  comps[[i]] <- forecast::ets(ts_dat[[i]])
  comps_resids[[i]] <- stats::resid(comps[[i]])
}

electricity_fpca_forecast <- do.call(cbind, comps_resids)

# Revert Back to functional objects
residuals1 <- electricity_fpca$harmonics$coefs %*% t(electricity_fpca_forecast)
residuals_fd <- fda::eval.basis(1:24, electricity_fd$basis) %*% residuals1
```

We use binary segmentation to investigate the residuals in this case.
```{r binary_segmantation, eval=FALSE}
set.seed(654321)
res <- binary_segmentation(X = residuals_fd,
                           statistic='Tn',
                           method='Sim',
                           h_function = function(X){ncol(X)^(1/3)})
colnames(residuals_fd)<- colnames(electricity)
plot(funts(residuals_fd), res[[1]]) 
```
